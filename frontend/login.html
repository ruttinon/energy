<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>EnergyLink ‚Äî Sign in</title>
  <style>
    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
      font-family: Segoe UI, Arial, sans-serif;
      color: #e0e1dd;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .card {
      width: 360px;
      background: #112f41;
      border: 1px solid #415a77;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .5);
      padding: 24px
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64dfdf;
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 12px
    }

    .title {
      font-size: 20px;
      color: #90e0ef;
      margin: 4px 0 16px
    }

    .field {
      position: relative;
      margin-bottom: 12px
    }

    .field input {
      width: 100%;
      padding: 12px 40px 12px 40px;
      border-radius: 8px;
      border: 1px solid #415a77;
      background: #1b263b;
      color: #e0e1dd;
      outline: none
    }

    .field input:focus {
      border-color: #64dfdf;
      box-shadow: 0 0 8px rgba(100, 223, 223, .2)
    }

    .icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: .7
    }

    .toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      opacity: .7;
      cursor: pointer
    }

    .roles {
      display: flex;
      gap: 8px;
      margin: 8px 0 16px
    }

    .seg {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      border: 1px solid #415a77;
      border-radius: 8px;
      background: #0f1b2b;
      color: #cce8ff;
      cursor: pointer
    }

    .seg.active {
      background: #1b4965;
      color: #64dfdf;
      border-color: #64dfdf
    }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #415a77;
      background: #0d3b66;
      color: #e0e1dd;
      cursor: pointer;
      font-weight: 600
    }

    .btn:disabled {
      opacity: .6;
      cursor: not-allowed
    }

    .msg {
      min-height: 20px;
      margin-top: 10px;
      color: #ff6b6b
    }
    .qrwrap { margin-top:14px; background:#0f1b2b; border:1px solid #415a77; border-radius:12px; padding:12px; display:none }
    .qrimg { width:220px; height:220px; display:block; margin:8px auto; border-radius:8px; background:#0d1b2a }
    .qrstatus { text-align:center; color:#64dfdf; font-weight:700 }
  </style>
</head>

<body>
  <div class="card">
    <div class="logo">‚ö° <span>ENERGYLINK</span></div>
    <div class="roles">
      <div class="seg active" data-mode="admin">Admin</div>
      <div class="seg" data-mode="user">User</div>
    </div>

    <div id="admin-wrap">
      <div class="title">Sign in</div>
      <div class="field"><span class="icon">üë§</span><input id="u" placeholder="Username" autocomplete="username"></div>
      <div class="field"><span class="icon">üîí</span><input id="p" type="password" placeholder="Password"
          autocomplete="current-password"><span class="toggle" id="toggle">üëÅÔ∏è</span></div>
      <button class="btn" id="login">Sign in (Admin)</button>
      <div class="msg" id="msg"></div>
      <button class="btn" id="qrbtn" style="margin-top:10px;background:#09395e">Login via QR</button>
      <div class="qrwrap" id="qrwrap">
        <img id="qrimg" class="qrimg" alt="QR"/>
        <div class="qrstatus" id="qrstatus">Scan with mobile to confirm</div>
      </div>
    </div>

    <div id="user-wrap" style="display:none">
      <div class="title">User Access</div>
      <div id="user-login-wrap" class="field"><span class="icon">üë§</span><input id="uu" placeholder="Username"></div>
      <div id="user-pass-wrap" class="field"><span class="icon">üîí</span><input id="pp" type="password" placeholder="Password"></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="user-open">Open</button>
        <button class="btn" id="user-qr" style="background:#09395e">Login via QR</button>
      </div>
      <div class="qrwrap" id="uqrwrap">
        <img id="uqrimg" class="qrimg" alt="QR"/>
        <div class="qrstatus" id="uqrstatus">Scan with mobile to confirm</div>
      </div>
      <div class="msg" id="user-msg"></div>
    </div>
  </div>
  <script src="/frontend/config.js"></script>
  <script>
    let mode = 'admin';
    document.querySelectorAll('.seg').forEach(x => {
      x.onclick = () => {
        document.querySelectorAll('.seg').forEach(y => y.classList.remove('active')); x.classList.add('active'); mode = x.dataset.mode;
        document.getElementById('admin-wrap').style.display = mode === 'admin' ? 'block' : 'none';
        document.getElementById('user-wrap').style.display = mode === 'user' ? 'block' : 'none';
        if (mode === 'user') loadPublicProjects();
      };
    });
    document.getElementById('toggle').onclick = () => { const p = document.getElementById('p'); p.type = p.type === 'password' ? 'text' : 'password'; };
    async function doLogin() {
      const btn = document.getElementById('login'); const msg = document.getElementById('msg'); msg.textContent = ''; btn.disabled = true;
      const u = document.getElementById('u').value.trim(); const p = document.getElementById('p').value;
      if (!u || !p) { msg.textContent = 'Enter username and password'; btn.disabled = false; return; }
      try {
        let res;
        const base = (window.__CONFIG && window.__CONFIG.apiBase) ? String(window.__CONFIG.apiBase).replace(/\/$/, '') : window.location.origin;
        res = await fetch(base + '/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) });
        if (res.status === 200) {
          const j = await res.json();
          const role = j.role || 'user';
          location.href = '/frontend/edit/index_admin.html';
        } else {
          msg.textContent = 'Invalid username or password';
        }
      } catch (e) { msg.textContent = 'Network error'; }
      btn.disabled = false;
    }
    document.getElementById('login').onclick = doLogin;
    document.addEventListener('keydown', e => { if (e.key === 'Enter' && mode === 'admin') doLogin(); });

    // QR LOGIN
    let qrToken = null; let qrTimer = null;
    async function startQR(){
      const base = (window.__CONFIG && window.__CONFIG.apiBase) ? String(window.__CONFIG.apiBase).replace(/\/$/, '') : window.location.origin;
      const res = await fetch(base + '/api/qr_login/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
      const j = await res.json();
      qrToken = j.token; document.getElementById('qrimg').src = j.qr; document.getElementById('qrwrap').style.display = 'block';
      document.getElementById('qrstatus').textContent = 'Scan with mobile and approve';
      if (qrTimer) { clearInterval(qrTimer); qrTimer=null; }
      qrTimer = setInterval(async ()=>{
        try{
          const r = await fetch(base + '/api/qr_login/status?token=' + encodeURIComponent(qrToken));
          const s = await r.json();
          if (s.status === 'approved'){
            clearInterval(qrTimer); qrTimer=null;
            const fin = await fetch(base + '/api/qr_login/finalize?token=' + encodeURIComponent(qrToken), { method:'POST' });
            if (fin.ok){
              location.href = '/frontend/edit/index_admin.html';
            } else {
              document.getElementById('qrstatus').textContent = 'Finalize failed';
            }
          } else if (s.status === 'expired'){
            document.getElementById('qrstatus').textContent = 'Expired ‚Äî click QR again';
            clearInterval(qrTimer); qrTimer=null;
          }
        }catch(e){ /* ignore */ }
      }, 1500);
    }
    document.getElementById('qrbtn').onclick = startQR;

    async function loadPublicProjects(){}
    document.getElementById('user-open').onclick = async () => {
      const pid = new URLSearchParams(location.search).get('pid');
      const uu = document.getElementById('uu'); const pp = document.getElementById('pp');
      if (uu && pp){
        try{
          const base = (window.__CONFIG && window.__CONFIG.apiBase) ? String(window.__CONFIG.apiBase).replace(/\/$/, '') : window.location.origin;
          const res = await fetch(base + '/api/login_user_any', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username: uu.value.trim(), password: pp.value }) });
          if (!res.ok){ document.getElementById('user-msg').textContent = 'Invalid credentials'; return; }
          const j = await res.json();
          location.href = j.redirect || ('/frontend/user.html?pid=' + encodeURIComponent(j.project_id));
          return;
        }catch(e){ document.getElementById('user-msg').textContent = 'Network error'; return; }
      }
      location.href = '/frontend/user.html?pid=' + encodeURIComponent(pid);
    };

    // User QR login bound to pid (if provided)
    async function startUserQR(pid){
      const base = (window.__CONFIG && window.__CONFIG.apiBase) ? String(window.__CONFIG.apiBase).replace(/\/$/, '') : window.location.origin;
      const res = await fetch(base + '/api/qr_login/start_user?project_id=' + encodeURIComponent(pid), { method:'POST' });
      const j = await res.json();
      document.getElementById('uqrimg').src = j.qr; document.getElementById('uqrwrap').style.display = 'block';
      if (window.__uqrTimer) { clearInterval(window.__uqrTimer); }
      window.__uqrTimer = setInterval(async ()=>{
        const st = await fetch(base + '/api/qr_login/status?token=' + encodeURIComponent(j.token));
        const sj = await st.json();
        if (sj.status === 'approved'){
          clearInterval(window.__uqrTimer);
          const fin = await fetch(base + '/api/qr_login/finalize?token=' + encodeURIComponent(j.token), { method:'POST' });
          const fj = await fin.json();
          const red = fj.redirect || ('/frontend/user.html?pid=' + encodeURIComponent(pid));
          location.href = red;
        }
      }, 1500);
    }
    document.getElementById('user-qr').onclick = ()=>{
      const pid = new URLSearchParams(location.search).get('pid');
      if (!pid){ document.getElementById('user-msg').textContent = 'QR requires project link'; return; }
      startUserQR(pid);
    };

    // If pid provided, hide dropdown and show credential fields
    (function initUserMode(){
      // No project input needed for typed login
    })();
  </script>
</body>

</html>
