<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WEBVIEW-S | Trends</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Rajdhani:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/frontend/user.css">

<style>
  /* Graph Page Specific Styles */
  :root {
      --bg: #0b1321;
      --panel: #111a2c;
      --border: #1f344e;
      --neon: #00d4ff;
      --neon-2: #3b82f6;
      --text: #e2e8f0;
      --muted: #94a3b8;
  }

  .mode-switch { display:flex; gap:12px; padding:12px 0; margin-bottom: 20px;}
  .mode-btn { position:relative; display:flex; align-items:center; gap:8px; padding:10px 18px; border-radius:14px; border:1px solid var(--border); color:var(--muted); background: linear-gradient(180deg, #0e182b, #0a1222); box-shadow: inset 0 0 0 1px #0b1a2c, 0 0 0 0 rgba(0,0,0,0); transition: all .18s ease; cursor: pointer; }
  .mode-btn .mode-icon { opacity:.9; }
  .mode-btn:hover { border-color:#2a436a; color:#cbd5e1; }
  .mode-btn.active { color:#dff8ff; border-color:#1573a6; box-shadow: 0 0 0 1px rgba(21,115,166,.6), 0 0 12px rgba(0,212,255,.35); background: radial-gradient(120% 120% at 10% 10%, rgba(0,212,255,.18) 0%, rgba(17,26,44,1) 38%), linear-gradient(180deg, #0f1d34, #0b1628); }

  .glass-card { background: linear-gradient(180deg, rgba(16,29,49,.8), rgba(14,24,40,.8)); border:1px solid var(--border); border-radius:16px; padding:16px; margin:12px 0; }
  .card-header { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
  .card-line { flex:1; height:2px; background: linear-gradient(90deg, var(--neon), transparent); opacity:.45; }
  .card-icon { width:26px; height:26px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:#7dd3fc; }

  .select-wrapper { position:relative; display: inline-block; min-width: 200px; }
  .select-wrapper select { width:100%; padding:9px 32px 9px 12px; border-radius:12px; border:1px solid var(--border); background: linear-gradient(180deg, #0e182b, #0a1222); color: var(--text); appearance:none; }
  .select-arrow { position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#7dd3fc; pointer-events:none; }

  .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .config-item { display: flex; flex-direction: column; gap: 8px; }
  .config-item label { font-size: 0.8rem; color: var(--muted); }

  .fields-box { grid-column: span 2; }
  .fields-container { display:flex; flex-direction:column; gap:8px; padding:10px; border:1px dashed #1e3a5f; border-radius:12px; min-height:52px; }
  .field-row { display:flex; align-items:center; gap:10px; color:var(--muted); }

  .chart-container { position:relative; height:420px; border:1px solid var(--border); border-radius:16px; overflow:hidden; background:#0b1628; width: 100%; }
  .chart-overlay { position:absolute; inset:0; pointer-events:none; background: linear-gradient(rgba(0,245,255,0.06) 1px, transparent 1px), linear-gradient(90deg, rgba(0,245,255,0.06) 1px, transparent 1px); background-size: 48px 48px, 48px 48px; opacity:.35; }

  .status-bar { margin-top:10px; display:flex; align-items:center; gap:8px; color:#9bdaf0; }
  .status-dot { width:8px; height:8px; border-radius:50%; background:#22c55e; box-shadow:0 0 8px #22c55e; }

  .time-controls { display:flex; align-items:flex-end; gap:14px; flex-wrap:wrap; margin-bottom:12px; }
  .date-field { display:flex; flex-direction:column; gap:6px; }
  .date-field input { padding:9px 12px; border-radius:12px; border:1px solid var(--border); background: linear-gradient(180deg, #0e182b, #0a1222); color: var(--text); }

  .range-buttons { display:flex; gap:8px; }
  .range-btn { padding:8px 12px; border-radius:12px; border:1px solid var(--border); color:#cbd5e1; background: linear-gradient(180deg, #0f1d34, #0b1628); cursor: pointer; }
  .range-btn.active, .range-btn:hover { border-color:#1573a6; color:#dff8ff; box-shadow:0 0 10px rgba(0,212,255,.25); }

  .waveform-controls { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
  .cyber-checkbox { display:inline-flex; align-items:center; gap:8px; color:#cbd5e1; cursor: pointer; }
  .cyber-checkbox input { width:18px; height:18px; accent-color:#22c55e; }
  .refresh-btn { padding:8px 12px; border-radius:12px; border:1px solid #176aa8; color:#e0f7ff; background: linear-gradient(180deg, #0f1d34, #0b1628); box-shadow:0 0 10px rgba(0,212,255,.25); cursor: pointer; }

  /* Layout Override for graph page to take full width of dashboard card area */
  .dashboard-card { display: block !important; overflow: visible !important; }
</style>

<script>
  window.goPage = window.goPage || function(path) {
    try { window.location.href = path; } catch(e) { console.warn('goPage fallback failed', e); }
  };
  window.logout = window.logout || function() {
    if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
      try { sessionStorage.clear(); localStorage.clear(); } catch(e){/*ignore*/}
      window.location.href = "/frontend/login.html";
    }
  };
</script>

</head>
<body>

<!-- Background Effects -->
<div class="cyber-grid"></div>
<div class="glow-orb orb-1"></div>
<div class="glow-orb orb-2"></div>
<div class="particles" id="particles"></div>

<!-- Header -->
<header>
  <div class="header-left">
    <div class="logo">
      <svg viewBox="0 0 40 40" class="logo-icon" width="40" height="40" aria-hidden="true">
        <polygon points="20,2 38,11 38,29 20,38 2,29 2,11" fill="none" stroke="url(#grad1)" stroke-width="1.5"/>
        <circle cx="20" cy="20" r="8" fill="none" stroke="url(#grad1)" stroke-width="1.5"/>
        <circle cx="20" cy="20" r="3" fill="url(#grad1)"/>
        <defs>
          <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#00d4ff"/>
            <stop offset="100%" style="stop-color:#00ffaa"/>
          </linearGradient>
        </defs>
      </svg>
      <div class="logo-text">
        <span class="brand">WEBVIEW-S</span>
        <span class="tagline">ENERGY HUB</span>
      </div>
    </div>
  </div>

  <div class="header-right">
    <div class="pill" id="projName">‚Äì</div>
    <button class="logout-btn" onclick="logout()">
      <span>LOGOUT</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true">
        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
      </svg>
    </button>
  </div>
</header>

<!-- Main Content -->
<main>
  <!-- Left: Quick Menu -->
  <section class="card menu-card">
    <div class="card-header">
      <span class="card-icon">‚óà</span>
      <h2>MONITOR</h2>
    </div>
    <div class="menu-grid">
      <div class="menu-item" onclick="goPage('/frontend/monitor/index.html')">
        <div class="menu-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="9"/><path d="M12 7v5l3 3"/>
          </svg>
        </div>
        <span>Dashboard</span>
      </div>
      <div class="menu-item" onclick="goPage('/frontend/monitor/index.html')">
        <div class="menu-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M12 9v4m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          </svg>
        </div>
        <span>Alarms</span>
      </div>
      <div class="menu-item" onclick="goPage('/frontend/monitor/index.html')">
        <div class="menu-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="14" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
          </svg>
        </div>
        <span>Photo</span>
      </div>
      <!-- Current Page -->
      <div class="menu-item active" onclick="goPage('/frontend/monitor/Traebds/graph.html')" style="border-color: var(--neon); box-shadow: 0 0 10px rgba(0,212,255,0.2);">
        <div class="menu-icon" aria-hidden="true" style="color: var(--neon);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 3v18h18"/><path d="M7 14l4-4 4 5 5-7"/>
          </svg>
        </div>
        <span style="color: #fff;">Trends</span>
      </div>
    </div>

    <div class="card-header" style="margin-top:20px;">
      <span class="card-icon">‚óà</span>
      <h2>ANALYSE</h2>
    </div>
    <div class="menu-grid single">
      <div class="menu-item wide" onclick="goPage('/frontend/monitor/index.html#energy')">
        <div class="menu-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="10" width="4" height="10"/><rect x="10" y="6" width="4" height="14"/><rect x="17" y="2" width="4" height="18"/>
          </svg>
        </div>
        <span>Consumption</span>
      </div>
    </div>
  </section>

  <!-- Right: Graph Content -->
  <section class="card dashboard-card">
    
    <!-- Mode Switch -->
    <div class="mode-switch">
      <button id="realtimeMode" class="mode-btn active">
        <span class="mode-icon">‚óâ</span> <span>REALTIME</span> <span class="mode-glow"></span>
      </button>
      <button id="historicalMode" class="mode-btn">
        <span class="mode-icon">‚ó∑</span> <span>HISTORICAL</span> <span class="mode-glow"></span>
      </button>
      <button id="waveformMode" class="mode-btn">
        <span class="mode-icon">‚àø</span> <span>WAVEFORM</span> <span class="mode-glow"></span>
      </button>
    </div>

    <!-- CONFIG -->
    <div class="card glass-card" style="margin-top:0;">
      <div class="card-header">
        <div class="card-icon">‚öô</div>
        <h2>CONFIGURATION</h2>
        <div class="card-line"></div>
      </div>

      <div class="config-grid">
        <div class="config-item">
          <label>CONVERTOR</label>
          <div class="select-wrapper">
            <select id="hist-conv"><option>Loading...</option></select>
            <span class="select-arrow">‚ñº</span>
          </div>
        </div>

        <div class="config-item">
          <label>DEVICE</label>
          <div class="select-wrapper">
            <select id="hist-device"><option>Select Convertor first</option></select>
            <span class="select-arrow">‚ñº</span>
          </div>
        </div>

        <div class="config-item fields-box">
          <label>DATA FIELDS</label>
          <div id="hist-key-container" class="fields-container">
            <span class="placeholder-text" style="color:var(--muted); font-size:14px;">‚ü® Select Device to load fields ‚ü©</span>
          </div>
        </div>
      </div>
    </div>

    <!-- REALTIME -->
    <div class="card glass-card graph-card" id="realtimeCard">
      <div class="card-header">
        <div class="card-icon pulse-icon">‚óâ</div>
        <h2>REALTIME MONITORING</h2>
        <div class="card-line"></div>
      </div>

      <div class="chart-type-selector" style="margin-bottom: 16px;">
        <label style="color:var(--muted); font-size:12px; margin-right:8px;">CHART TYPE</label>
        <div class="select-wrapper">
          <select id="realtimeChartTypeSelect">
            <option value="line">üìà LINE</option>
            <option value="area">üìä AREA</option>
            <option value="bar">üìä BAR</option>
            <option value="scatter">‚ö´ SCATTER</option>
            <option value="step">üìâ STEP</option>
          </select>
          <span class="select-arrow">‚ñº</span>
        </div>
      </div>

      <div class="chart-container hologram-5d">
        <canvas id="realtimeChart"></canvas>
        <div class="chart-overlay"></div>
      </div>

      <div class="status-bar">
        <span class="status-dot"></span>
        <span id="multi-status-realtime">‚ü® Awaiting data stream... ‚ü©</span>
      </div>
    </div>

    <!-- HISTORICAL -->
    <div class="card glass-card graph-card" id="historicalCard" style="display:none;">
      <div class="card-header">
        <div class="card-icon">‚ó∑</div>
        <h2>HISTORICAL ANALYSIS</h2>
        <div class="card-line"></div>
      </div>

      <div class="time-controls">
        <div class="date-inputs" style="display:flex; gap:12px; align-items: flex-end;">
          <div class="date-field">
            <label style="color:var(--muted); font-size:11px;">START</label><input type="date" id="startDate">
          </div>
          <div class="date-field">
            <label style="color:var(--muted); font-size:11px;">END</label><input type="date" id="endDate">
          </div>
        </div>

        <div class="range-buttons">
          <button class="range-btn" data-range="1d">1D</button>
          <button class="range-btn" data-range="7d">7D</button>
          <button class="range-btn" data-range="1m">1M</button>
          <button class="range-btn" data-range="1y">1Y</button>
        </div>

        <div class="chart-type-selector" style="margin-left:auto;">
          <label style="color:var(--muted); font-size:12px; margin-right:8px;">CHART TYPE</label>
          <div class="select-wrapper">
            <select id="chartTypeSelect">
              <option value="line">üìà LINE</option>
              <option value="area">üìä AREA</option>
              <option value="bar">üìä BAR</option>
              <option value="scatter">‚ö´ SCATTER</option>
              <option value="step">üìâ STEP</option>
            </select>
            <span class="select-arrow">‚ñº</span>
          </div>
        </div>
      </div>

      <div class="chart-container hologram-5d">
        <canvas id="historyChart"></canvas>
        <div class="chart-overlay"></div>
      </div>

      <div class="status-bar">
        <span class="status-dot"></span>
        <span id="multi-status">‚ü® Awaiting data... ‚ü©</span>
      </div>
    </div>

    <!-- WAVEFORM -->
    <div class="card glass-card graph-card" id="waveformCard" style="display:none;">
      <div class="card-header">
        <div class="card-icon">‚àø</div>
        <h2>WAVEFORM ANALYSIS</h2>
        <div class="card-line"></div>
      </div>

      <div class="waveform-controls">
        <label class="cyber-checkbox">
          <input type="checkbox" id="wf-l1" checked><span class="checkmark"></span>L1
        </label>
        <label class="cyber-checkbox">
          <input type="checkbox" id="wf-l2" checked><span class="checkmark"></span>L2
        </label>
        <label class="cyber-checkbox">
          <input type="checkbox" id="wf-l3" checked><span class="checkmark"></span>L3
        </label>
        <button id="wf-refresh" class="refresh-btn"><span class="refresh-icon">‚ü≥</span> REFRESH</button>
      </div>

      <div class="chart-container hologram-5d">
        <canvas id="waveformChart"></canvas>
        <div class="chart-overlay"></div>
      </div>

      <div class="status-bar">
        <span class="status-dot"></span>
        <span id="waveform-status">‚ü® Awaiting waveform data... ‚ü©</span>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-line"></div>
  <span>¬© 2025 WEBVIEW-S ‚Ä¢ ENERGY MONITORING SYSTEM</span>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

<script type="module">
import { initRealtimeGraphModule, stopGraphInterval } 
    from "/frontend/monitor/Traebds/realtime_graph_module.js";

import { initGraphModule, drawCombinedGraph, loadHistoricalSelectors } 
    from "/frontend/monitor/Traebds/graph_module.js";

import { initWaveformGraphModule, stopWaveformInterval } 
    from "/frontend/monitor/Traebds/waveform_graph_module.js";

/* Floating background particles */
function createParticles() {
  const container = document.getElementById('particles');
  if (!container) return;
  for (let i = 0; i < 50; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDelay = Math.random() * 20 + 's';
    p.style.animationDuration = (15 + Math.random() * 20) + 's';
    container.appendChild(p);
  }
}
createParticles();

/* 5D Parallax Hover Effect */
document.addEventListener("mousemove", e => {
  const box = document.querySelector(".hologram-5d");
  if (!box) return;
  const rect = box.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width - 0.5;
  const y = (e.clientY - rect.top) / rect.height - 0.5;

  box.style.transform = `perspective(900px) rotateX(${y * 6}deg) rotateY(${x * -6}deg)`;
});
document.addEventListener("mouseleave", e => {
  const box = document.querySelector(".hologram-5d");
  if (box) box.style.transform = "perspective(900px) rotateX(0deg) rotateY(0deg)";
});

/* Mode Switching */
async function switchMode(mode) {  
  stopGraphInterval();
  if (typeof stopWaveformInterval === 'function') stopWaveformInterval();

  const cards = {
    realtime: document.getElementById("realtimeCard"),
    historical: document.getElementById("historicalCard"),
    waveform: document.getElementById("waveformCard")
  };

  Object.values(cards).forEach(c => c.style.display = "none");
  document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));

  if (mode === "realtime") {
    cards.realtime.style.display = "block";
    document.getElementById("realtimeMode").classList.add("active");
    initRealtimeGraphModule();

  } else if (mode === "historical") {
    cards.historical.style.display = "block";
    document.getElementById("historicalMode").classList.add("active");
    initGraphModule();

  } else if (mode === "waveform") {
    cards.waveform.style.display = "block";
    document.getElementById("waveformMode").classList.add("active");
    initWaveformGraphModule();
  }
}

document.getElementById("realtimeMode").onclick = () => switchMode("realtime");
document.getElementById("historicalMode").onclick = () => switchMode("historical");
document.getElementById("waveformMode").onclick = () => switchMode("waveform");

/* Initial load */
setTimeout(() => initRealtimeGraphModule(), 500);

/* Load Convertors */
// Simple fetch wrapper to replace the complex Sidebar communication
// Since we are now a standalone page, we load selectors directly.
document.addEventListener("DOMContentLoaded", async () => {
    // Initial device loading (if not handled by module)
    try {
        await loadHistoricalSelectors(); 
    } catch(e) {
        console.warn("Auto-load selectors failed", e);
    }
});

// Mocking "deviceConfirmed" if it's strictly needed by modules, 
// but modules likely manipulate DOM elements directly. 
// We just need to make sure the Modules can find #hist-conv, etc.

</script>

</body>
</html>
